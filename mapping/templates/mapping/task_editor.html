<!-- mapping/templates/index.html -->
{% extends 'bootstrap_base.html' %}


{% block content %}
<div class="row">
  <div class="col col-sm-3">
    <div class="card">
      <div class="card-header text-white bg-info">
        <h5 class="card-title">Taken</h5>
      </div>
      <div class="card-body">
        <select onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);" class="form-control">
            <option>---</option>  
            {% for value in project_list.values %}
              <option value="{% url "mapping:index" %}project/{{value.id}}"{% if current_project.id == value.id %} selected {% endif %}>{{value.title}}</option>
            {% endfor %}
        </select>
      
        <select onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);" class="form-control">
            <option value="{% url "mapping:index" %}status_filter/{{current_task.project_id.id}}/{{current_task.id}}/0">Alle taken</option>  
        {% for value in status_list %}
          {% if value.id != current_project.status_complete.id %}
            <option value="{% url "mapping:index" %}status_filter/{{current_task.project_id.id}}/{{current_task.id}}/{{value.id}}"{% if status_filter == value.id %} selected {% endif %}>{{value.status_title}}</option>     
          {% endif %}
        {% endfor %}
        </select> 

        <select onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);" class="form-control">
            <option value="{% url "mapping:index" %}status_filter/{{current_task.project_id.id}}/{{current_task.id}}/{{status_filter}}/0"{% if own_task_filter == 0 %} selected {% endif %}>Taken van alle gebruikers</option>  
            <option value="{% url "mapping:index" %}status_filter/{{current_task.project_id.id}}/{{current_task.id}}/{{status_filter}}/1"{% if own_task_filter == 1 %} selected {% endif %}>Alleen eigen taken</option>  
        </select> 
      </div>
    </div>
    <div class="card">
      <div class="card-header text-white bg-info">
          <b>{{tasks_shown}} van {{tasks_total}} taken zichtbaar</b>
          <div class="pagination">
            <span class="step-links">
                {% if objects.has_previous %}
                    <a href="?page=1" class=" text-white">&laquo;</a>
                    <a href="?page={{ objects.previous_page_number }}" class=" text-white">&lsaquo; vorige</a>
                {% endif %}
          
                <span class="current">
                    <strong>Pagina {{ objects.number }} van {{ objects.paginator.num_pages }}.</strong>
                </span>
          
                {% if objects.has_next %}
                    <a href="?page={{ objects.next_page_number }}" class=" text-white">volgende &rsaquo;</a>
                    <a href="?page={{ objects.paginator.num_pages }}" class=" text-white">&raquo;</a>
                {% endif %}
            </span>
          </div>
      </div>
      <div class="card-body" style="height: 600px; overflow:auto;">
          {% for value in tasks.values %}
              <a id="{{value.id}}" href="{% url "mapping:index" %}project/{{current_project.id}}/task/{{value.id}}" style="text-decoration : none">
                <span style="display: block;">  
                  {% if value.id == current_task.id %}
                  <li class="list-group-item list-group-item-info">
                  {% else %}
                  <li class="list-group-item list-group-item-light">
                  {% endif %}
                  <!-- <p>Taak: {{value.id}} / {{value.project_title}} / {{value.source_codesystem}}) -> {{value.target_codesystem}}</p> -->
                  {{value.source_component_title}}<br>
                  <small><b>{{value.status.status_title}}</b></small>
                  {% if own_task_filter == 0 %} @{{value.user.username}} {% endif %}
                  <!-- <p><a href="{% url "mapping:index" %}project/{{current_project.id}}/task/{{value.id}}">Open taak</a></p> -->
                  </li>
                </span>
              </a>
          {% endfor %}
      </div>
      <script>
        $( document ).ready(function() {
          javascript:document.getElementById('{{current_task.id}}').scrollIntoView(true);
          setTimeout(() => {
            window.scrollBy(0,-500)
          }, 0);
        });
      </script> 

      <form action="{% url "mapping:index" %}tasksearch/{{current_project.id}}/">
        <select name="task_id" value="{{form.target_component.value}}" class="form-control js-select2-tasksearch">
        </select>
        <input type="submit" value="Open taak" class="form-control">
      </form>
    </div>
  </div>
  <div class="col col-sm-5">
      <div class="card">
        <div class="card-header text-white bg-info"><h5 class="card-title">Te mappen concept</h5></div>
        <div class="card-body">
          <table class="table table-hover table-sm">
            <tr><td style="width: 150px">ID: </td><td>{{source_component.component_id}} [{{source_component.codesystem}} {{source_component.codesystem_version}}]</td></tr>
            <tr><td style="width: 150px">Term: </td><td>{{source_component.title}}</td></tr>
            {% if source_component.extra_1 and source_component.extra_1 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_1}}: </td><td>{{source_component.extra_1}}</td></tr>{% endif %}
            {% if source_component.extra_2 and source_component.extra_2 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_2}}: </td><td>{{source_component.extra_2}}</td></tr>{% endif %}
            {% if source_component.extra_3 and source_component.extra_3 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_3}}: </td><td>{{source_component.extra_3}}</td></tr>{% endif %}
            {% if source_component.extra_4 and source_component.extra_4 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_4}}: </td><td>{{source_component.extra_4}}</td></tr>{% endif %}
            {% if source_component.extra_5 and source_component.extra_5 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_5}}: </td><td>{{source_component.extra_5}}</td></tr>{% endif %}
            {% if source_component.extra_6 and source_component.extra_6 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_6}}: </td><td>{{source_component.extra_6}}</td></tr>{% endif %}
            {% if source_component.extra_7 and source_component.extra_7 != 'nan'  %}<tr><td style="width: 150px">{{current_codesystem.codesystem_extra_7}}: </td><td>{{source_component.extra_7}}</td></tr>{% endif %}
          </table>
        </div>
      </div>

      <div class="card">
        <div class="card-header">Status</div>
        <div class="card-body text-center">
          {% if 'mapping | change task status' in permissions and current_user.id == current_task.user.id %}
            {% for status in status_list %}
              {% if current_task.status.id == status.id %}
              <button class="btn btn-info">{{status.status_title}}</button>
              {% else %}
              <a href="{% url "mapping:index" %}status_update/{{current_task.id}}/{{status.id}}/" class="btn btn-light" role=button>{{status.status_title}}</a>
              {% endif %}
            {% endfor %}
          {% else %}
            <p>Huidige status is: <strong>{{current_task.status.status_title}}</strong></p>
            <p>Huidige gebruiker is: <strong>{{current_task.user.username}}</strong></p>
          {% endif %}
        </div>
      </div>

      <div class="card">
        <div class="card-header">Doorsturen naar</div>
        <div class="card-body">
        {% if 'mapping | change task status' in permissions %}
        <!-- Start change task user -->
          <select onchange="this.options[this.selectedIndex].value && (window.location = this.options[this.selectedIndex].value);" class="form-control">
              <option>---</option>  
              {% for value in user_list.values %}
                <option value="{% url "mapping:index" %}change_user/{{current_task.id}}/{{value.id}}"{% if current_task.user.id == value.id %} selected {% endif %}>{{value.username}}</option>
              {% endfor %}
          </select>
          <!-- End change task user -->
          {% else %}
          <p>Taak is toegewezen aan: <strong>{{current_task.user.username}}</strong></p>
          {% endif %}
        </div>
      </div>


      <div class="card">
        <div class="card-header">Commentaar</div>
        <div class="card-body">
          {% if 'mapping | place comments' in permissions %}
          <!-- Start author comment -->
          <form action="{% url "mapping:post_comment" %}" method="POST">
            {% csrf_token %}
            {{ comments_form.project_id }} {{ comments_form.task_id }}
            {{ comments_form.comment_body }}
            <input type="submit" value="Plaats" class="form-control"><br>
          </form>
          <!-- End author comment -->
          {% endif %}

          <ul class="list-group">
            {% for event in events %}
              {% if event.type == 'comment' %}
              <!-- If comment -->
                <li class="list-group-item">
                  {{event.text|linebreaks}}
                  <small>{{event.user}} @ {{event.created}} <a href="{% url "mapping:index" %}deletecomment/{{event.id}}">
                    {% if event.user == current_user.username %}
                    [delete]
                    {% endif %}</a></small>
                </li>
              <!-- End if comment -->
              {% endif %}
              {% if event.type == 'status_change' %}
              <!-- Start if event -->
              <li class="list-group-item list-group-item-warning" >
                <a tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="Dismissible popover" data-content="{{event.created}} - {{event.data}}">{{event.text}}</a>
              </li>
              <!-- End if event -->
              {% endif %}
              {% if event.type == 'user_change' %}
              <!-- Start if event -->
              <li class="list-group-item list-group-item-warning"><!-- style="height:20px;overflow: hidden; padding:3px; line-height: 10px;" -->
                <a tabindex="0" role="button" data-toggle="popover" data-trigger="focus" title="Dismissible popover" data-content="{{event.created}} - {{event.data}}">{{event.text}}</a>
              </li>
              <!-- End if event -->
              {% endif %}
            {% endfor %}
          </ul>
        </div>
      </div>
  </div>
  <div class="col col-sm-4">
    <div class="card">
        <div class="card-header text-white bg-info"><h5 class="card-title">Doel</h5></div>
    </div>
    <div>
          <form method="post">
              {% csrf_token %}
              {{ formset.management_form }}
              <ul class="list-group">
              {% if 'mapping | edit mapping' in permissions and current_user.id == current_task.user.id %}
                  <!-- WITH EDIT RIGHTS -->
                  {% for form in formset %}
                      {% if not form.target_component.value %}
                      <li class="list-group-item">
                          <b>Nieuwe mapping</b><br>
                      {% else %}
                      {% if not form.active.value %}
                      <li class="list-group-item list-group-item-warning">
                      {% elif form.active.value %}
                      <li class="list-group-item list-group-item-success">
                      {% endif %}
                      {% endif %}
                      {{ form.id }} {{ form.source_component }} {{ form.target_component }}
                      
                      <table class="table table-sm">
                          <tbody>
                            {% if formset.can_delete and form.target_component.value %}
                              <tr>
                                  <th scope="row">Huidig</th>
                                  <td>
                                    {% if form.target_component_codesystem.value == "Snomed" %}
                                    <a class="btn btn-info" style="text-align: left;" href="https://browser.ihtsdotools.org/?perspective=full&conceptId1={{ form.target_component_ident.value }}&edition=MAIN/SNOMEDCT-NL&release=&languages=nl,en" target="_blank">
                                    {% endif %}
                                    <b>Stelsel</b> {{ form.target_component_codesystem.value }}  <b>ID</b> {{ form.target_component_ident.value }}<br>{{ form.target_component_term.value }} 
                                    {% if form.target_component_codesystem.value == "Snomed" %}
                                    </a>
                                    {% endif %}
                                  </td>
                              </tr>
                            {% endif %}
                            <tr>
                            <th scope="row" colspan="2">
                                <select name="{{form.prefix}}-target_component" value="{{form.target_component.value}}" class="form-control js-select2-mappingtarget">
                                </select>
                            </th>
                            </tr>
                            <tr>
                                <th scope="row">Actief</th>
                                <td>{{ form.active }}</td>
                            </tr>
                            {% if current_project.use_mapgroup %}
                            <tr>
                                <th scope="row">Mapgroup</th>
                                <td>{{ form.mapgroup }}</td>
                            </tr>
                            {% endif %}
                            {% if current_project.use_mapcorrelation %}
                            <tr>
                                <th scope="row">Map correlation</th>
                                <td>{{ form.mapcorrelation }}</td>
                            </tr>
                            {% endif %}
                            {% if current_project.use_mappriority %}
                            <tr>
                                <th scope="row">Map priority</th>
                                <td>{{ form.mappriority }}</td>
                            </tr>
                            {% endif %}
                            {% if current_project.use_mapadvice %}
                            <tr>
                                <th scope="row">Map advice</th>
                                <td>{{ form.mapadvice }}</td>
                            </tr>
                            {% endif %}
                            {% if current_project.use_maprule %}
                            <tr>
                                <th scope="row">Map rule</th>
                                <td>{{ form.maprule }}</td>
                            </tr>
                            {% endif %}
                            {% if formset.can_delete and form.target_component.value %}
                            <tr>
                                <th scope="row">Verwijderen</th>
                                <td>{{ form.DELETE }}</td>
                                </tr>
                            {% endif %}
                          
                          </tbody>
                      </table>
                      </li>
                  {% endfor %}
                  <div class="card"><div class="card-body"><input type="submit" value="Opslaan" class="form-control"></div></div>
                  <!-- END WITH EDIT RIGHTS -->
              {% else %}
                  <!-- WITHOUT EDIT RIGHTS -->
                  {% for form in formset %}
                      {% if form.target_component.value %}
                      {% if not form.active.value %}
                          <li class="list-group-item list-group-item-warning">
                          {% elif form.active.value %}
                          <li class="list-group-item list-group-item-success">
                      {% endif %}
                      
                      <table class="table">
                          <tbody>
                          {% if formset.can_delete and form.target_component.value %}
                          <tr>
                              <th scope="row">Huidig</th>
                              <td>
                                {% if form.target_component_codesystem.value == "Snomed" %}
                                <a class="btn btn-info" style="text-align: left;" href="https://browser.ihtsdotools.org/?perspective=full&conceptId1={{ form.target_component_ident.value }}&edition=MAIN/SNOMEDCT-NL&release=&languages=nl,en" target="_blank">
                                {% endif %}
                                [{{ form.target_component_codesystem.value }}] {{ form.target_component_term.value }} [{{ form.target_component_ident.value }}]
                                {% if form.target_component_codesystem.value == 1 %}
                                </a>
                                {% endif %}
                              </td>
                          </tr>
                          {% endif %}
                          <tr>
                              <th scope="row">Actief</th>
                              <td>{{ form.active.value }}</td>
                          </tr>
                          {% if current_project.use_mapgroup %}
                          <tr>
                              <th scope="row">Mapgroup</th>
                              <td>{{ form.mapgroup.value }}</td>
                          </tr>
                          {% endif %}
                          {% if current_project.use_mapcorrelation %}
                          <tr>
                              <th scope="row">Map correlation</th>
                              <td>{{ form.mapcorrelation.value }}</td>
                          </tr>
                          {% endif %}
                          {% if current_project.use_mappriority %}
                          <tr>
                              <th scope="row">Map priority</th>
                              <td>{{ form.mappriority.value }}</td>
                          </tr>
                          {% endif %}
                          {% if current_project.use_mapadvice %}
                          <tr>
                              <th scope="row">Map advice</th>
                              <td>{{ form.mapadvice.value }}</td>
                          </tr>
                          {% endif %}
                          {% if current_project.use_maprule %}
                          <tr>
                              <th scope="row">Map rule</th>
                              <td>{{ form.maprule.value }}</td>
                          </tr>
                          {% endif %}
                          </tbody>
                      </table>
                      </li>
                      {% endif %}
                  {% endfor %}
                  <!-- END WITHOUT EDIT RIGHTS -->
              {% endif %}
              </ul>
          </form>
        </div>
    </div>
  </div>
</div>




<script>
$(document).ready(function() {
    $('.js-select2-mappingtarget').select2({
    ajax: {
    url: "{% url "mapping:index" %}ajaxtargetsearch/",
    dataType: 'json',
    delay: 250,
    data: function (params) {
      return {
        term: params.term, // search term
        page: params.page
      };
    },
    processResults: function (data, params) {
      params.page = params.page || 1;

      return {
        results: data.items
      };
    },
    cache: true
  },
  placeholder: 'Zoeken naar mapping target',
  minimumInputLength: 3,
  templateResult: formatRepo,
  templateSelection: formatRepoSelection
  })

  function formatRepo (repo) {
    if (repo.loading) {
      return repo.text;
    }

    var $container = $(
      "<div class='select2-result-repository clearfix'>" +
          "<div class='select2-result-repository__title'></div>" +
          "<div class='select2-result-repository__codesystem'></div>" +
          "<div class='select2-result-repository__description'></div>" +
          "<div class='select2-result-repository__codesystemId'></div>" +
      "</div>"
    );

    $container.find(".select2-result-repository__title").text(repo.text);
    $container.find(".select2-result-repository__codesystem").text('[Codesystem '+repo.codesystem+']');
    // $container.find(".select2-result-repository__description").text('[intern ID '+repo.id+']');
    $container.find(".select2-result-repository__codesystemId").text(repo.comp_id);

    return $container;
  }


  function formatRepoSelection (repo) {
    return repo.text || repo.id;
  }
});
</script>
<script>
  $(document).ready(function() {
      $('.js-select2-tasksearch').select2({
      ajax: {
      url: "{% url "mapping:index" %}tasksearch/{{current_project.id}}/",
      dataType: 'json',
      delay: 250,
      data: function (params) {
        return {
          term: params.term, // search term
          page: params.page
        };
      },
      processResults: function (data, params) {
        params.page = params.page || 1;
  
        return {
          results: data.items
        };
      },
      cache: true
    },
    placeholder: 'Zoek naar een taak in het project',
    minimumInputLength: 3,
    templateResult: formatRepo,
    templateSelection: formatRepoSelection
    })
  
    function formatRepo (repo) {
      if (repo.loading) {
        return repo.text;
      }
  
      var $container = $(
        "<div class='select2-result-repository clearfix'>" +
            "<div class='select2-result-repository__title'></div>" +
            "<div class='select2-result-repository__codesystem'></div>" +
            "<div class='select2-result-repository__description'></div>" +
            "<div class='select2-result-repository__codesystemId'></div>" +
        "</div>"
      );
  
      $container.find(".select2-result-repository__title").text(repo.text);
      $container.find(".select2-result-repository__codesystem").text('[Codesystem '+repo.codesystem+']');
      // $container.find(".select2-result-repository__description").text('[intern ID '+repo.id+']');
      $container.find(".select2-result-repository__codesystemId").text(repo.comp_id);
  
      return $container;
    }
  
  
    function formatRepoSelection (repo) {
      return repo.text || repo.id;
    }
  });
</script>
<script>
$(function () {
  $('[data-toggle="popover"]').popover()
})</script>
{% endblock content %}